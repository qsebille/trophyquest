name: Deploy backend application to AWS (EC2)

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - ".github/workflows/backend-deploy.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Build Spring Boot jar
        working-directory: backend
        run: |
          set -e
          chmod +x gradlew
          ./gradlew clean bootJar

          APP_VERSION=$(grep '^version=' gradle.properties | cut -d'=' -f2)
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV

          JAR_FILE=$(ls build/libs/*.jar | head -n 1)
          # on stocke le chemin depuis la racine du repo
          echo "JAR_FILE=backend/$JAR_FILE" >> $GITHUB_ENV

          echo "Built backend/$JAR_FILE (version $APP_VERSION)"

      - name: Upload jar to S3 (artifact)
        id: upload_jar_to_s3
        run: |
          set -e
          S3_KEY="backend/${GITHUB_SHA}/trophyquest-backend-${APP_VERSION}.jar"
          echo "s3_key=$S3_KEY" >> $GITHUB_ENV

          aws s3 cp "${JAR_FILE}" "s3://${{ secrets.ARTIFACT_S3_BUCKET }}/${S3_KEY}"

      - name: Deploy on EC2 via SSM
        run: |
          set -e

          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ secrets.BACKEND_EC2_INSTANCE_ID }}" \
            --comment "Deploy TrophyQuest backend ${APP_VERSION} (${GITHUB_SHA})" \
            --parameters commands="[
              \"set -e\",
              \"aws s3api get-object --bucket ${{ secrets.ARTIFACT_S3_BUCKET }} --key ${S3_KEY} /tmp/trophyquest-backend.jar\",
              \"sudo mv /tmp/trophyquest-backend.jar /opt/trophyquest/trophyquest-backend.jar\",
              \"sudo chown trophyquest:trophyquest /opt/trophyquest/trophyquest-backend.jar\",
              \"sudo systemctl restart trophyquest-backend\",
              \"sudo systemctl status trophyquest-backend --no-pager -l\"
            ]" \
            --query "Command.CommandId" --output text)

          echo "SSM CommandId: $COMMAND_ID"

          set +e
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.BACKEND_EC2_INSTANCE_ID }}"
          WAIT_RC=$?
          set -e

          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.BACKEND_EC2_INSTANCE_ID }}" \
            --query "{Status:Status,ResponseCode:ResponseCode,StdOut:StandardOutputContent,StdErr:StandardErrorContent}" \
            --output json

          exit $WAIT_RC

